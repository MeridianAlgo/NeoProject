name: Rotating Ticker Training

on:
  schedule:
    # Train every 30 minutes, rotating through tickers
    - cron: '0,30 * * * *'
  workflow_dispatch:
    inputs:
      ticker:
        description: 'Ticker to train on'
        required: true
        default: 'BTC-USD'
        type: choice
        options:
          - BTC-USD
          - ETH-USD
          - SPY
          - QQQ

permissions:
  contents: write

jobs:
  train:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          lfs: true

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'

      - name: Install Dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Determine Ticker
        id: ticker
        run: |
          # Determine which ticker to train based on the 30-min slot in a 2-hour window
          # Hour % 2 gives 0 or 1.
          # Minute is 0 or 30.
          # Slots (4 total):
          # 0:00 -> BTC-USD (H%2=0, M=0)
          # 0:30 -> ETH-USD (H%2=0, M=30)
          # 1:00 -> SPY     (H%2=1, M=0)
          # 1:30 -> QQQ     (H%2=1, M=30)
          
          HOUR_PARITY=$(($(date -u +%H) % 2))
          MINUTE=$(date -u +%M)
          
          if [ "${{ github.event_name }}" == "workflow_dispatch" ]; then
            TICKER="${{ github.event.inputs.ticker }}"
          else
            if [ $HOUR_PARITY -eq 0 ]; then
                if [ $MINUTE -lt 30 ]; then TICKER="BTC-USD"; else TICKER="ETH-USD"; fi
            else
                if [ $MINUTE -lt 30 ]; then TICKER="SPY"; else TICKER="QQQ"; fi
            fi
          fi
          echo "ticker=$TICKER" >> $GITHUB_OUTPUT
          echo "Training on: $TICKER"

      - name: Train Model
        env:
          WANDB_API_KEY: ${{ secrets.WANDB_API_KEY }}
          ALPACA_API_KEY: ${{ secrets.ALPACA_API_KEY }}
          ALPACA_SECRET_KEY: ${{ secrets.ALPACA_SECRET_KEY }}
          ALPACA_BASE_URL: https://paper-api.alpaca.markets
        run: |
          python neo.py --train --steps 100000 --ticker ${{ steps.ticker.outputs.ticker }}

      - name: Get Training Stats
        id: stats
        run: |
          # Count total training runs
          TRAIN_COUNT=$(git rev-list --count HEAD --grep="Automated training" 2>/dev/null || echo "0")
          TRAIN_COUNT=$((TRAIN_COUNT + 1))
          echo "count=$TRAIN_COUNT" >> $GITHUB_OUTPUT
          
          # Get model size
          MODEL_SIZE=$(du -sh models/ | cut -f1)
          echo "model_size=$MODEL_SIZE" >> $GITHUB_OUTPUT
          
          # Get database size
          DB_SIZE=$(du -sh data/trading_bot.db | cut -f1)
          echo "db_size=$DB_SIZE" >> $GITHUB_OUTPUT

      - name: Commit and Push Updated Model
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"
          git add -A
          git commit -m "ðŸ¤– Automated training #${{ steps.stats.outputs.count }} on ${{ steps.ticker.outputs.ticker }} [skip ci]" || echo "No changes to commit"
          git push || git push --force

      - name: Create Release Tag
        if: success()
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          TAG_NAME="train-${{ steps.ticker.outputs.ticker }}-$(date -u +%Y%m%d-%H%M%S)"
          
          # Extract metrics from JSON
          TR_PCT=$(jq -r '.total_return_pct' eval_results.json)
          BH_PCT=$(jq -r '.buy_and_hold_return_pct' eval_results.json)
          SMA_PCT=$(jq -r '.sma_return_pct' eval_results.json)
          SHARPE=$(jq -r '.sharpe_ratio' eval_results.json)
          MDD=$(jq -r '.max_drawdown_pct' eval_results.json)
          WR=$(jq -r '.win_rate_pct' eval_results.json)
          TRADES=$(jq -r '.total_trades' eval_results.json)
          FW=$(jq -r '.final_net_worth' eval_results.json)

          # Determine badge color based on performance
          if [[ $TR_PCT == -* ]]; then COLOR="red"; else COLOR="green"; fi
          
          # Create tag with clean multi-line message
          git tag -a "$TAG_NAME" -m "ðŸ¤– NEO Training Release
          -------------------------
          Ticker: ${{ steps.ticker.outputs.ticker }}
          Return: ${TR_PCT}%
          Sharpe: ${SHARPE}
          Win Rate: ${WR}%"
          
          git push origin "$TAG_NAME"
          
          # Create GitHub Release with premium formatting
          RELEASE_NOTES=$(cat <<EOF
          # ðŸš€ NEO v4 Training Session: ${{ steps.ticker.outputs.ticker }}
          
          ![Return](https://img.shields.io/badge/Return-${TR_PCT}%25-${COLOR}?style=for-the-badge)
          ![Sharpe](https://img.shields.io/badge/Sharpe-${SHARPE}-blue?style=for-the-badge)
          ![WinRate](https://img.shields.io/badge/Win%20Rate-${WR}%25-gold?style=for-the-badge)

          ### ðŸ“ˆ Performance Assessment
          | Metric | Result | vs Baseline |
          | :--- | :--- | :--- |
          | **Total Return** | \`${TR_PCT}%\` | \`${BH_PCT}%\` (B&H) |
          | **Sharpe Ratio** | \`${SHARPE}\` | \`-\` |
          | **Max Drawdown** | \`${MDD}%\` | \`-\` |
          | **Win Rate** | \`${WR}%\` | \`-\` |
          | **Total Trades** | \`${TRADES}\` | \`-\` |
          
          ### ðŸ“Š Portfolio Evolution
          - **Starting Capital**: \`$10,000.00\`
          - **Ending Net Worth**: \`$${FW}\`
          - **SMA Baseline**: \`${SMA_PCT}%\`
          
          ### ðŸ¤– Environment Metadata
          - **Ticker Focus**: \`${{ steps.ticker.outputs.ticker }}\`
          - **Training Iteration**: #${{ steps.stats.outputs.count }}
          - **Model Size**: \`${{ steps.stats.outputs.model_size }}\`
          - **Database Scope**: \`${{ steps.stats.outputs.db_size }}\`
          - **Architecture**: Recurrent PPO (LSTM)
          
          ### ðŸ”— Monitoring
          View detailed charts and real-time convergence on the [Weights & Biases Dashboard](https://wandb.ai/home).
          
          ---
          *Generated by Neo Autonomous Intelligence*
          EOF
          )
          gh release create "$TAG_NAME" \
            --title "ðŸš€ Training #${{ steps.stats.outputs.count }}: ${{ steps.ticker.outputs.ticker }} (${TR_PCT}%)" \
            --notes "$RELEASE_NOTES" \
            models/neo_recurrent_v4.zip
