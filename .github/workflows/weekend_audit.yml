name: Weekend Rigorous Audit

on:
  schedule:
    # Run at 12:00 UTC every Saturday and Sunday
    - cron: '0 12 * * 6,0'
  workflow_dispatch:
    inputs:
      ticker:
        description: 'Ticker to stress test'
        required: true
        default: 'SPY'
        type: choice
        options:
          - BTC-USD
          - ETH-USD
          - SPY
          - QQQ

permissions:
  contents: write

jobs:
  audit:
    name: Rigorous Performance Audit
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          lfs: true

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'

      - name: Install Dependencies
        run: |
          python -m pip install --upgrade pip
          sudo apt-get install -y jq bc
          pip install -r requirements.txt

      - name: Determine Ticker
        id: ticker
        run: |
          if [ "${{ github.event_name }}" == "workflow_dispatch" ]; then
            TICKER="${{ github.event.inputs.ticker }}"
          else
            # Rotate: Sat = SPY, Sun = BTC-USD
            DAY=$(date +%u)
            if [ "$DAY" -eq 6 ]; then TICKER="SPY"; else TICKER="BTC-USD"; fi
          fi
          echo "ticker=$TICKER" >> $GITHUB_OUTPUT

      - name: Run Rigorous OOS Tests
        env:
          WANDB_API_KEY: ${{ secrets.WANDB_API_KEY }}
        run: |
          python neo.py --test --ticker ${{ steps.ticker.outputs.ticker }}

      - name: Create Audit Release
        if: success()
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          TAG_NAME="audit-${{ steps.ticker.outputs.ticker }}-$(date -u +%Y%m%d)"
          
          # Extract metrics from JSON
          TR_PCT=$(jq -r '.total_return_pct' eval_results.json)
          BH_PCT=$(jq -r '.buy_and_hold_return_pct' eval_results.json)
          SHARPE=$(jq -r '.sharpe_ratio' eval_results.json)
          VOL=$(jq -r '.ann_volatility_pct' eval_results.json)
          PF=$(jq -r '.profit_factor' eval_results.json)
          MDD=$(jq -r '.max_drawdown_pct' eval_results.json)
          WR=$(jq -r '.win_rate_pct' eval_results.json)
          TRADES=$(jq -r '.total_trades' eval_results.json)
          LONG=$(jq -r '.long_bias_pct' eval_results.json)
          SHORT=$(jq -r '.short_bias_pct' eval_results.json)
          CASH=$(jq -r '.cash_bias_pct' eval_results.json)
          FW=$(jq -r '.final_net_worth' eval_results.json)

          if [[ $TR_PCT == -* ]]; then COLOR="red"; else COLOR="green"; fi
          
          RELEASE_NOTES=$(cat <<EOF
          # ðŸ›¡ï¸ Weekend Rigorous Audit: ${{ steps.ticker.outputs.ticker }}
          
          > **Strategic Review Required**: This is a high-pressure stress test on unseen 2025 data. Review these metrics to decide on hyperparameter tweaks for next week's training cycle.
          
          ![Return](https://img.shields.io/badge/OOS_Return-${TR_PCT}%25-${COLOR}?style=for-the-badge)
          ![Sharpe](https://img.shields.io/badge/Sharpe-${SHARPE}-blue?style=for-the-badge)
          ![ProfitFactor](https://img.shields.io/badge/Profit_Factor-${PF}-purple?style=for-the-badge)

          ### ðŸ“‰ Performance Deep Dive
          | Primary Metric | Agent Result | Market Baseline (B&H) |
          | :--- | :--- | :--- |
          | **Total Net Return** | \`${TR_PCT}%\` | \`${BH_PCT}%\` |
          | **Risk-Adjusted (Sharpe)** | \`${SHARPE}\` | \`-\` |
          | **Max Peak-to-Trough** | \`${MDD}%\` | \`-\` |
          | **Annualized Volatility** | \`${VOL}%\` | \`-\` |
          
          ### ðŸ› ï¸ Execution & Strategy Efficiency
          | Execution Metric | Value |
          | :--- | :--- |
          | **Profit Factor** | \`${PF}\` |
          | **Win Rate** | \`${WR}%\` |
          | **Total Trade Events** | \`${TRADES}\` |
          | **Avg. Capital Utilization** | \`$${FW}\` final equity |

          ### ðŸ—ï¸ Portfolio Bias (Exposure)
          > How much time did the agent spend in each state?
          - ðŸ“ˆ **Long Exposure**: \`${LONG}%\`
          - ðŸ“‰ **Short Exposure**: \`${SHORT}%\`
          - ðŸ’µ **Cash/Neutral**: \`${CASH}%\`
          
          ### ðŸ“Š Analysis for Next Week
          - **Regime Check**: If Cash/Neutral is high, the agent is being defensive.
          - **Risk Check**: If Drawdown is $>15\%$, we need to increase the `vf_coef` or add more price features to the environment.
          - **Profit Check**: A Profit Factor $<1.1$ indicates the model is just coin-flipping; check the `learning_rate`.

          Detailed equity curves and holding patterns are available in the [Weights & Biases Audit Dashboard](https://wandb.ai/home). 
          
          ---
          *Neo v4 Rigorous Audit System - Generated on $(date)*
          EOF
          )
          
          gh release create "$TAG_NAME" \
            --title "ðŸ›¡ï¸ Weekend Audit: ${{ steps.ticker.outputs.ticker }} (${TR_PCT}%)" \
            --notes "$RELEASE_NOTES"
